#!/usr/bin/php
<?php

ini_set("memory_limit", -1);

if (is_dir(__DIR__ . '/tracks') === false)
{
	mkdir(__DIR__ . '/tracks');
}

$configFile = file_get_contents(__DIR__ . '/config.json');
$config = json_decode($configFile);

if (json_last_error() !== JSON_ERROR_NONE)
{
	throw new Exception('The config file is invalid.');
}

$clientID = $config->client_id;
$userID = (int)$config->user_id;
$apiURL = $config->api_url;

$favoritesURL = "{$config->api_url}/users/{$userID}/favorites.json?client_id={$clientID}";
$favoritesJSON = file_get_contents($favoritesURL);
$favorites = json_decode($favoritesJSON);

foreach($favorites as $track)
{
	$path = __DIR__ . '/tracks/' . $track->user->permalink . ' - ' . $track->permalink . '.mp3';
	if (file_exists($path) === false)
	{
		if ($track->downloadable === true && isset($track->download_url) === true)
		{
			$s = file_get_contents("{$config->api_url}/tracks/{$track->id}/download?client_id={$clientID}");
		}
		else
		{
			$s = file_get_contents("{$config->api_url}/tracks/{$track->id}/stream?client_id={$clientID}");
		}
		file_put_contents($path, $s);
	}
	echo $path . PHP_EOL;
}